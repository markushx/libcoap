# Makefile for libcoap
#
# Copyright (C) 2010 Olaf Bergmann <bergmann@tzi.org>
# 
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

# the library's version
VERSION:=0.07

# tools

SHELL = /bin/sh
MKDIR = mkdir


abs_builddir = /opt/tinyos-2.1.1/apps/libcoap
top_builddir = .
package = libcoap-0.07

# files and flags
SOURCES:= pdu.c net.c debug.c encode.c uri.c list.c subscribe.c str.c
#jni_swig.c
OBJECTS:= $(patsubst %.c, %.o, $(SOURCES))
HEADERS:=coap.h config.h debug.h pdu.h net.h encode.h uri.h list.h mem.h subscribe.h str.h de_tzi_coap_CoapTest.h
WRAPPER:=$(patsubst %.c, %_wrap.c, $(SOURCES))

#INTERFACES:=debug.i pdu.i net.i encode.i uri.i list.i subscribe.i str.i constant.i socket.i
INTERFACES:=debug.i pdu.i net.i encode.i uri.i list.i subscribe.i str.i constant.i socket.i server.i
JAVA:= $(patsubst %.i, %.java, $(INTERFACES))

#CFLAGS:=-g -Wall -ansi -pedantic
CFLAGS:=-Wall -ansi -pedantic -g -O2 -I/usr/lib/jvm/java-6-sun/include/ -I/usr/lib/jvm/java-6-sun/include/linux/ -I/usr/lib/jvm/java-1.5.0-sun/include/ -I/usr/lib/jvm/java-1.5.0-sun/include/linux/
DISTDIR=$(top_builddir)/$(package)
SUBDIRS:=examples doc
FILES:=Makefile.in configure configure.in config.h.in $(SOURCES) $(HEADERS)
LIB:=libcoap.a
SOLIB:=libcoap.so
LDFLAGS:=
ARFLAGS:=cru
examples:=examples
doc:=doc

########java############
JFLAGS = -g
JC = javac

.SUFFIXES: .java .class
.java.class:
	$(JC) $(JFLAGS) $*.java

javatest:	
	javah -jni -classpath /opt/tinyos-2.1.1/apps/libcoap -d /opt/tinyos-2.1.1/apps/libcoap/ de.tzi.coap.Coap
	#gcc -I/usr/lib/jvm/java-6-sun/include/ -I/usr/lib/jvm/java-6-sun/include/linux/ -I/usr/lib/jvm/java-1.5.0-sun/include/ -I/usr/lib/jvm/java-1.5.0-sun/include/linux/ -shared /opt/tinyos-2.1.1/apps/libcoap/de/tzi/coap/jni_swig.c -o /opt/tinyos-2.1.1/apps/libcoap/libjni_swig.so
	#gcc -I/usr/lib/jvm/java-6-sun/include/ -I/usr/lib/jvm/java-6-sun/include/linux/ -I/usr/lib/jvm/java-1.5.0-sun/include/ -I/usr/lib/jvm/java-1.5.0-sun/include/linux/ -shared /opt/tinyos-2.1.1/apps/libcoap/de/tzi/coap/jni_swig_wrap.c -o /opt/tinyos-2.1.1/apps/libcoap/libjni_swig_wrap.so

coaptest:
#	javac -cp . de/tzi/coap/CoapTest.java
#	javah -jni -classpath /opt/tinyos-2.1.1/apps/libcoap -d /opt/tinyos-2.1.1/apps/libcoap/ de.tzi.coap.CoapTest
#	gcc -I/usr/lib/jvm/java-6-sun/include/ -I/usr/lib/jvm/java-6-sun/include/linux/ -I/usr/lib/jvm/java-1.5.0-sun/include/ -I/usr/lib/jvm/java-1.5.0-sun/include/linux/ -shared /opt/tinyos-2.1.1/apps/libcoap/de/tzi/coap/CoapTest.c -o /opt/tinyos-2.1.1/apps/libcoap/CoapTest.o
	gcc -I/usr/lib/jvm/java-6-sun/include/ -I/usr/lib/jvm/java-6-sun/include/linux/ -I/usr/lib/jvm/java-1.5.0-sun/include/ -I/usr/lib/jvm/java-1.5.0-sun/include/linux/ -shared /opt/tinyos-2.1.1/apps/libcoap/socket_wrap.c -o /opt/tinyos-2.1.1/apps/libcoap/socket_wrap.o
	gcc -I/usr/lib/jvm/java-6-sun/include/ -I/usr/lib/jvm/java-6-sun/include/linux/ -I/usr/lib/jvm/java-1.5.0-sun/include/ -I/usr/lib/jvm/java-1.5.0-sun/include/linux/ -shared /opt/tinyos-2.1.1/apps/libcoap/server_wrap.c -o /opt/tinyos-2.1.1/apps/libcoap/server_wrap.o

coap:
#	javac -cp . de/tzi/coap/jni/CoapSwigJNI.java
#	javac -cp . de/tzi/coap/jni/CoapSwig.java
	javac -cp . de/tzi/coap/Coap.java

client:
	javac -cp . de/tzi/coap/Client.java
	javac -cp . de/tzi/coap/Server.java

#########

.PHONY: all dirs clean distclean .gitignore doc

.SUFFIXES:
.SUFFIXES:      .c .o

all:	$(LIB) $(SOLIB) dirs

check:
	echo DISTDIR: $(DISTDIR)
	echo top_builddir: $(top_builddir)
	$(MAKE) -C examples check

dirs:	$(SUBDIRS)
	for dir in $^; do \
		$(MAKE) -C $$dir ; \
	done

$(LIB):	$(OBJECTS)
	$(AR) $(ARFLAGS) $@ $^
	ranlib $@
#	javah -jni -classpath /opt/tinyos-2.1.1/apps/libcoap -d /opt/tinyos-2.1.1/apps/libcoap/ de.tzi.coap.Coap
	

$(SOLIB):	$(OBJECTS) $(WRAPPER) /opt/tinyos-2.1.1/apps/libcoap/socket_wrap.o  /opt/tinyos-2.1.1/apps/libcoap/server_wrap.o
	gcc -I/usr/lib/jvm/java-6-sun/include/ -I/usr/lib/jvm/java-6-sun/include/linux/ -I/usr/lib/jvm/java-1.5.0-sun/include/ -I/usr/lib/jvm/java-1.5.0-sun/include/linux/ -shared -Wl,-soname,$@ -o $@ $^

swig:
	mkdir -p de/tzi/coap/jni/

	for ifc in $(INTERFACES); do \
		swig -java -includeall -package de.tzi.coap.jni -outdir de/tzi/coap/jni/ $$ifc; \
	done

	javac de/tzi/coap/jni/*.java; \

#	for jv in $(JAVA); do \
#		javac de/tzi/coap/jni/$$jv; \
#	done
# coap.i, config.i, mem.i needed as well?
	

clean:
	@rm -f $(PROGRAM) main.o $(LIB) $(SOLIB) $(OBJECTS) $(WRAPPER)
	for dir in $(SUBDIRS); do \
		$(MAKE) -C $$dir clean ; \
	done

doc:
	$(MAKE) -C doc

distclean:	clean
	@rm -rf $(DISTDIR)
	@rm -f *~ $(DISTDIR).tar.gz

dist:	$(FILES) $(SUBDIRS)
	test -d $(DISTDIR) || mkdir $(DISTDIR)
	cp $(FILES) $(DISTDIR)
	for dir in $(SUBDIRS); do \
		$(MAKE) -C $$dir dist; \
	done
	tar czf $(package).tar.gz $(DISTDIR)

.gitignore:
	echo "core\n*~\n*.[oa]\n*.gz\n*.cap\n$(PROGRAM)\n$(DISTDIR)\n.gitignore" >$@
